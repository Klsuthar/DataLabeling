<script type="text/javascript">
        var gk_isXlsx = false;
        var gk_xlsxFileLookup = {};
        var gk_fileData = {};
        function filledCell(cell) {
          return cell !== '' && cell != null;
        }
        function loadFileData(filename) {
        if (gk_isXlsx && gk_xlsxFileLookup[filename]) {
            try {
                var workbook = XLSX.read(gk_fileData[filename], { type: 'base64' });
                var firstSheetName = workbook.SheetNames[0];
                var worksheet = workbook.Sheets[firstSheetName];

                // Convert sheet to JSON to filter blank rows
                var jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1, blankrows: false, defval: '' });
                // Filter out blank rows (rows where all cells are empty, null, or undefined)
                var filteredData = jsonData.filter(row => row.some(filledCell));

                // Heuristic to find the header row by ignoring rows with fewer filled cells than the next row
                var headerRowIndex = filteredData.findIndex((row, index) =>
                  row.filter(filledCell).length >= filteredData[index + 1]?.filter(filledCell).length
                );
                // Fallback
                if (headerRowIndex === -1 || headerRowIndex > 25) {
                  headerRowIndex = 0;
                }

                // Convert filtered JSON back to CSV
                var csv = XLSX.utils.aoa_to_sheet(filteredData.slice(headerRowIndex)); // Create a new sheet from filtered array of arrays
                csv = XLSX.utils.sheet_to_csv(csv, { header: 1 });
                return csv;
            } catch (e) {
                console.error(e);
                return "";
            }
        }
        return gk_fileData[filename] || "";
        }
        </script><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Facial Data Collection Tool</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: #1a202c; 
            color: #ffffff; 
        }
        .grid-card { 
            background-color: rgba(31, 41, 55, 0.8);
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .input-field { 
            width: 100%;
            padding: 0.5rem;
            background-color: #1f2937;
            color: white;
            border: 1px solid #374151;
            border-radius: 0.375rem;
        }
        .input-field:focus {
            outline: none;
            box-shadow: 0 0 0 2px rgba(99, 102, 241, 0.5);
        }
        .input-field[multiple] {
            height: 100px;
        }
        .color-dot { 
            width: 1.5rem;
            height: 1.5rem;
            border-radius: 9999px;
            border: 1px solid #374151;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .color-dot:hover {
            transform: scale(1.1);
        }
        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.375rem 0.375rem 0 0;
            transition: background-color 0.2s;
        }
        .tab-btn.active {
            background-color: #374151;
            font-weight: 500;
        }
        .tab-content {
            display: none;
            padding-top: 1rem;
        }
        .tab-content.active {
            display: block;
        }
        .tooltip {
            position: relative;
        }
        .tooltip:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            bottom: 100%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #4b5563;
            color: white;
            padding: 0.25rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            white-space: nowrap;
            z-index: 10;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .form-group label {
            display: block;
            margin-bottom: 0.25rem;
            font-size: 0.875rem;
            color: #d1d5db;
        }
        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #jsonPreview {
            max-height: 300px;
            overflow-y: auto;
            font-family: monospace;
            white-space: pre-wrap;
        }
        /* Custom Tag Input Styles */
        .tag-box {
            display: flex;
            flex-wrap: wrap;
            align-items: center;
            border: 1px solid #374151;
            padding: 6px;
            background-color: #1f2937;
            border-radius: 0.375rem;
            cursor: text;
            min-height: 38px;
        }
        .tag {
            background-color: #374151;
            padding: 5px 10px;
            margin: 4px;
            border-radius: 3px;
            display: flex;
            align-items: center;
            font-size: 14px;
            color: #d1d5db;
            font-family: Arial, sans-serif;
        }
        .tag span {
            margin-left: 8px;
            cursor: pointer;
            font-weight: bold;
            color: #9ca3af;
        }
        .tag span:hover {
            color: #ef4444;
        }
        .tag-input {
            border: none;
            outline: none;
            font-size: 14px;
            padding: 5px;
            min-width: 120px;
            background-color: #1f2937;
            color: #ffffff;
            font-family: Arial, sans-serif;
        }
        .tag-box.empty::before {
            content: "Enter lighting tags (e.g., Natural, Indoor)...";
            color: #6b7280;
            padding-left: 6px;
            font-size: 14px;
            font-family: Arial, sans-serif;
        }
    </style>
</head>
<body class="min-h-screen py-8">
    <div class="max-w-7xl mx-auto grid grid-cols-1 lg:grid-cols-2 gap-6 px-4">
        <!-- Left Panel -->
        <div class="grid-card">
            <div class="toolbar flex flex-wrap justify-between items-center bg-gray-900 px-4 py-2 rounded-xl mb-4">
                <span class="py-1" id="landmarkLabel">üìç Landmarks: <span id="collectedCount">0</span>/40</span>
                <div class="flex flex-wrap gap-2">
                    <button id="toggleModeBtn" class="px-2 py-1 bg-gray-800 rounded hover:bg-gray-700 transition-all tooltip" data-tooltip="Switch between landmarks and colors">üé® Mode: Landmarks</button>
                    <button id="undoBtn" class="px-2 py-1 bg-gray-800 rounded hover:bg-gray-700 transition-all tooltip" data-tooltip="Undo last action" disabled>‚Ü∫ Undo</button>
                    <button id="redoBtn" class="px-2 py-1 bg-gray-800 rounded hover:bg-gray-700 transition-all tooltip" data-tooltip="Redo last undone action" disabled>‚Üª Redo</button>
                    <label class="px-2 py-1 bg-gray-800 rounded hover:bg-gray-700 cursor-pointer transition-all tooltip" data-tooltip="Upload an image">
                        üì∑ Upload
                        <input type="file" id="imageInput" accept="image/jpeg,image/png" class="hidden">
                    </label>
                    <button id="resetBtn" class="px-2 py-1 bg-gray-800 rounded hover:bg-gray-700 transition-all tooltip" data-tooltip="Reset all values">üîÑ Reset</button>
                </div>
            </div>
            <div class="relative">
                <div id="dropZone" class="w-full h-64 border-2 border-dashed border-gray-700 rounded-lg flex items-center justify-center">
                    <p>Drag & drop image here or use upload button</p>
                </div>
                <canvas id="imageCanvas" class="w-full rounded-lg border-2 border-gray-700 hidden"></canvas>
                <div id="currentLandmark" class="absolute top-2 left-2 bg-black/70 px-2 py-1 rounded text-sm hidden"></div>
            </div>
            
            <!-- Color dots -->
            <div class="mt-4 space-y-3">
                <div>
                    <h3 class="text-sm font-medium mb-1">Clothes Colors:</h3>
                    <div class="flex space-x-2">
                        <div id="clothes_colour_0" class="color-dot bg-gray-700"></div>
                        <div id="clothes_colour_1" class="color-dot bg-gray-700"></div>
                        <div id="clothes_colour_2" class="color-dot bg-gray-700"></div>
                        <div id="clothes_colour_3" class="color-dot bg-gray-700"></div>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-medium mb-1">Background Colors:</h3>
                    <div class="flex space-x-2">
                        <div id="background_colour_0" class="color-dot bg-gray-700"></div>
                        <div id="background_colour_1" class="color-dot bg-gray-700"></div>
                        <div id="background_colour_2" class="color-dot bg-gray-700"></div>
                        <div id="background_colour_3" class="color-dot bg-gray-700"></div>
                    </div>
                </div>
                <div>
                    <h3 class="text-sm font-medium mb-1">Skin Tones:</h3>
                    <div class="flex space-x-2">
                        <div id="skin_tone_0" class="color-dot bg-gray-700"></div>
                        <div id="skin_tone_1" class="color-dot bg-gray-700"></div>
                        <div id="skin_tone_2" class="color-dot bg-gray-700"></div>
                        <div id="skin_tone_3" class="color-dot bg-gray-700"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Panel -->
        <div class="grid-card overflow-y-auto max-h-[100vh]">
            <nav class="flex space-x-2 border-b border-gray-700 pb-2">
                <button data-tab="basic" class="tab-btn active">Basic Info</button>
                <button data-tab="advanced" class="tab-btn">Advanced</button>
                <button data-tab="export" class="tab-btn">Export</button>
            </nav>
            
            <!-- Basic Info Tab -->
            <div id="basicTab" class="tab-content active space-y-4">
                <h2 class="text-xl font-semibold mb-4">Camera Details</h2>
                <div class="form-group">
                    <label for="unique_id">Unique ID (required)</label>
                    <input type="text" id="unique_id" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="file_name">File Name</label>
                    <input type="text" id="file_name" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="file_extension">File Extension</label>
                    <input type="text" id="file_extension" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="file_size">File Size</label>
                    <input type="text" id="file_size" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="dimensions">Dimensions</label>
                    <input type="text" id="dimensions" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="comments">Comments</label>
                    <input type="text" id="comments" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="date">Date</label>
                    <input type="text" id="date" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="make">Camera Maker</label>
                    <input type="text" id="make" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="model">Camera Model</label>
                    <input type="text" id="model" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="f_stop">F-stop</label>
                    <input type="text" id="f_stop" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="exposure_time">Exposure Time</label>
                    <input type="text" id="exposure_time" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="iso_speed">ISO Speed</label>
                    <input type="text" id="iso_speed" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="exposure_bias">Exposure Bias</label>
                    <input type="text" id="exposure_bias" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="focal_length">Focal Length</label>
                    <input type="text" id="focal_length" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="max_aperture">Max Aperture</label>
                    <input type="text" id="max_aperture" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="metering_mode">Metering Mode</label>
                    <input type="text" id="metering_mode" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="flash_mode">Flash Mode</label>
                    <input type="text" id="flash_mode" class="input-field" readonly>
                </div>
                <div class="form-group">
                    <label for="focal_length_35mm">35mm Focal Length</label>
                    <input type="text" id="focal_length_35mm" class="input-field" readonly>
                </div>
                
                <h2 class="text-xl font-semibold mb-4 mt-6">Personal Details</h2>
                <div class="form-group">
                    <label for="name">Name</label>
                    <input type="text" id="name" class="input-field" value="Kanhaiyalal">
                </div>
                <div class="form-group">
                    <label for="age_days">Age (Day)</label>
                    <input type="text" id="age_days" class="input-field" readonly>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="height_cm">Height (cm)</label>
                        <input type="number" id="height_cm" class="input-field" min="0" value="178">
                    </div>
                    <div class="form-group">
                        <label for="weight_kg">Weight (kg)</label>
                        <input type="number" id="weight_kg" class="input-field" min="0" value="72">
                    </div>
                </div>
                
                <h2 class="text-xl font-semibold mb-4 mt-6">Location</h2>
                <div class="form-group" style="color: #1a202c;">
                    <label for="city">City</label>
                    <select id="city" class="input-field" multiple>
                        <option value="Dhadheru_Godaran" style="color: white;">Dhadheru_Godaran</option>
                        <option value="Jaipur" style="color: white;">Jaipur</option>
                        <option value="custom" style="color: white;">Custom</option>
                    </select>
                </div>
                <div id="custom_city_container" class="form-group hidden">
                    <label for="custom_city">Custom City</label>
                    <input type="text" id="custom_city" class="input-field">
                </div>
                <div class="form-group">
                    <label for="latitude_longitude">Latitude, Longitude</label>
                    <input type="text" id="latitude_longitude" class="input-field" value="27.964547992823288, 74.34065413108007">
                </div>
            </div>
            
            <!-- Advanced Tab -->
            <div id="advancedTab" class="tab-content space-y-4">
                <h2 class="text-xl font-semibold mb-4">Image Source</h2>
                <div class="form-group">
                    <label for="image_source">Image Source</label>
                    <select id="image_source" class="input-field">
                        <option value="">Select source</option>
                        <option value="DSLR">DSLR</option>
                        <option value="Smartphone" selected>Smartphone</option>
                        <option value="Webcam">Webcam</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                <div id="custom_image_source_container" class="form-group hidden">
                    <label for="custom_image_source">Custom Image Source</label>
                    <input type="text" id="custom_image_source" class="input-field">
                </div>
                
                <h2 class="text-xl font-semibold mb-4 mt-6">Face Details</h2>
                <div class="form-group">
                    <label for="expression">Expression</label>
                    <select id="expression" class="input-field">
                        <option value="">Select expression</option>
                        <option value="Neutral" selected>Neutral</option>
                        <option value="Smiling">Smiling</option>
                        <option value="Serious">Serious</option>
                        <option value="Surprised">Surprised</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                <div id="custom_expression_container" class="form-group hidden">
                    <label for="custom_expression">Custom Expression</label>
                    <input type="text" id="custom_expression" class="input-field">
                </div>
                
                <div class="form-group">
                    <label for="skin_condition">Skin Condition</label>
                    <select id="skin_condition" class="input-field">
                        <option value="">Select condition</option>
                        <option value="Normal" selected>Normal</option>
                        <option value="Dry">Dry</option>
                        <option value="Oily">Oily</option>
                        <option value="Custom">Custom</option>
                    </select>
                </div>
                <div id="custom_skin_condition_container" class="form-group hidden">
                    <label for="custom_skin_condition">Custom Skin Condition</label>
                    <input type="text" id="custom_skin_condition" class="input-field">
                </div>
                
                <div class="form-group">
                    <label for="wrinkles">Wrinkles</label>
                    <select id="wrinkles" class="input-field">
                        <option value="" disabled>Select option</option>
                        <option value="None" selected>None</option>
                        <option value="Mild">Mild</option>
                        <option value="Moderate">Moderate</option>
                        <option value="Severe">Severe</option>
                    </select>
                </div>
                
                <h2 class="text-xl font-semibold mb-4 mt-6">Appearance</h2>
                <div class="form-group">
                    <label for="hair_color">Hair Color</label>
                    <select id="hair_color" class="input-field">
                        <option value="">Select color</option>
                        <option value="Black" selected>Black</option>
                        <option value="White">White</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="beard_length_mm">Beard Length (mm)</label>
                    <select id="beard_length_mm" class="input-field">
                        <option value="">Select length</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                        <option value="6">6</option>
                        <option value="7">7</option>
                        <option value="8">8</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="moustache">Moustache</label>
                    <select id="moustache" class="input-field">
                        <option value="Yes" selected>Yes</option>
                        <option value="No">No</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="moustache_colour">Moustache Colour</label>
                    <select id="moustache_colour" class="input-field">
                        <option value="Black" selected>Black</option>
                        <option value="White">White</option>
                        <option value="Na">Na</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="bath_status">Photo is Taken</label>
                    <select id="bath_status" class="input-field">
                        <option value="After Bath" selected>After Bath</option>
                        <option value="Before Bath">Before Bath</option>
                    </select>
                </div>
                <div class="form-group" style="color: #1a202c;">
                    <label for="clothes">Clothes</label>
                    <select id="clothes" class="input-field" multiple>
                        <option value="shirt" style="color: #ffffff;">Shirt</option>
                        <option value="t-shirt" style="color: #ffffff;">T-shirt</option>
                        <option value="coat" style="color: #ffffff;">Coat</option>
                        <option value="custom" style="color: #ffffff;">Custom</option>
                    </select>
                </div>
                <div id="custom_clothes_container" class="form-group hidden">
                    <label for="custom_clothes">Custom Clothes</label>
                    <input type="text" id="custom_clothes" class="input-field">
                </div>
                
                <h2 class="text-xl font-semibold mb-4 mt-6">Environment</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="lighting">Lighting</label>
                        <div id="lightingTagBox" class="tag-box empty" onclick="focusLightingInput()">
                            <input type="text" id="lightingTagInput" class="tag-input" onkeydown="handleLightingKey(event)" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="uv_index">UV Index (1-11)</label>
                        <input type="number" id="uv_index" class="input-field" min="1" max="11" value="10">
                    </div>
                </div>
                <div class="form-group">
                    <label for="aqi">Air Quality Index (0-500)</label>
                    <input type="number" id="aqi" class="input-field" min="0" max="500">
                </div>
                <div class="form-group">
                    <label for="humidity_percent">Humidity (%)</label>
                    <select id="humidity_percent" class="input-field">
                        <option value="">Select humidity</option>
                        ${Array.from({length: 100}, (_, i) => `<option value="${i + 1}">${i + 1}</option>`).join('')}
                    </select>
                </div>
                
                <h2 class="text-xl font-semibold mb-4 mt-6">Lifestyle</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="form-group">
                        <label for="sleep">Sleep (hours)</label>
                        <input type="number" id="sleep" class="input-field" min="0" max="24" step="0.5" value="8">
                    </div>
                    <div class="form-group">
                        <label for="exercise">Exercise (hours)</label>
                        <input type="number" id="exercise" class="input-field" min="0" max="4" step="0.5" value="0">
                    </div>
                </div>
                
                <h2 class="text-xl font-semibold mb-4 mt-6">Health Metrics</h2>
                <div class="form-group">
                    <label for="medications">Medications (comma-separated)</label>
                    <input type="text" id="medications" class="input-field" value="Na">
                </div>
                <div class="form-group">
                    <label for="skincare">Skincare Routine</label>
                    <textarea id="skincare" class="input-field" rows="3">Na</textarea>
                </div>
                
                <h2 class="text-xl font-semibold mb-4 mt-6">Additional Information</h2>
                <div class="form-group">
                    <label for="life_events">Recent Life Events</label>
                    <textarea id="life_events" class="input-field" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label for="tags">Tags (comma-separated)</label>
                    <input type="text" id="tags" class="input-field">
                </div>
                
                <h2 class="text-xl font-semibold mb-4 mt-6">Landmark Coordinates</h2>
                <div class="form-group">
                    <textarea id="landmarkCoordinates" class="input-field h-32" readonly></textarea>
                </div>
            </div>
            
            <!-- Export Tab -->
            <div id="exportTab" class="tab-content space-y-4">
                <div class="flex flex-col md:flex-row justify-between gap-4 mb-6">
                    <button id="exportBtn" class="px-4 py-2 bg-gradient-to-r from-blue-500 to-purple-500 rounded-md hover:from-blue-600 hover:to-purple-600 transition-all">
                        Export JSON
                    </button>
                    <div class="relative">
                        <label class="px-4 py-2 bg-gray-700 rounded-md hover:bg-gray-600 cursor-pointer transition-all">
                            Import JSON
                            <input type="file" id="jsonInput" accept=".json" class="hidden">
                        </label>
                    </div>
                </div>
                
                <h3 class="text-lg font-medium mb-2">JSON Preview</h3>
                <pre id="jsonPreview" class="text-xs bg-gray-800 p-3 rounded-md"></pre>
            </div>
        </div>
    </div>
    
    <script>
        // Constants and Global Variables
        const landmarkKeys = [
            'left_eye.outer', 'left_eye.top', 'left_eye.inner', 'left_eye.bottom', 'left_eye.center',
            'right_eye.outer', 'right_eye.top', 'right_eye.inner', 'right_eye.bottom', 'right_eye.center',
            'left_eyebrow.outer', 'left_eyebrow.middle', 'left_eyebrow.inner',
            'right_eyebrow.outer', 'right_eyebrow.middle', 'right_eyebrow.inner',
            'nose.tip', 'nose.bridge', 'nose.left_nostril', 'nose.right_nostril',
            'mouth.left_corner', 'mouth.upper_lip', 'mouth.right_corner', 'mouth.lower_lip', 'mouth.center',
            'chin.tip', 'jaw.left', 'jaw.right',
            'cheek.left', 'cheek.right',
            'ear.left.top', 'ear.left.middle', 'ear.left.bottom',
            'ear.right.top', 'ear.right.middle', 'ear.right.bottom',
            'forehead.left', 'forehead.center', 'forehead.right',
            'neck.adam_apple'
        ];
        
        const canvas = document.getElementById('imageCanvas');
        const ctx = canvas.getContext('2d');
        const dropZone = document.getElementById('dropZone');
        const currentLandmark = document.getElementById('currentLandmark');
        
        let image = new Image();
        let originalImage = null;
        let landmarks = {};
        let landmarkIndex = 0;
        let colorMode = null;
        let selectedColorBox = null;
        
        let clothesColours = ['', '', '', ''];
        let backgroundColours = ['', '', '', ''];
        let skinTones = ['', '', '', ''];
        
        let history = [];
        let redoStack = [];
        
        let isImporting = false;
        
        const apiBaseUrl = 'http://localhost:3000';
        
        // Initialize the application
        function init() {
            setupEventListeners();
            setupLightingTagInput();
            updateUI();
            updateJsonPreview();
        }
        
        // Calculate age in days from birth date to given date
        function calculateAgeInDays(birthDate, captureDate) {
            const diffTime = captureDate - birthDate;
            return Math.floor(diffTime / (1000 * 60 * 60 * 24));
        }
        
        // Parse EXIF date string (YYYY:MM:DD HH:MM:SS)
        function parseExifDate(dateString) {
            if (!dateString) return null;
            const [datePart, timePart] = dateString.split(' ');
            const [year, month, day] = datePart.split(':').map(Number);
            const [hours, minutes, seconds] = timePart ? timePart.split(':').map(Number) : [0, 0, 0];
            return new Date(year, month - 1, day, hours, minutes, seconds);
        }
        
        // Clean non-alphanumeric characters
        function cleanExifValue(value) {
            return value ? value.replace(/[^a-zA-Z0-9\s]/g, '') : '';
        }
        
        // Set up all event listeners
        function setupEventListeners() {
            // File upload
            document.getElementById('imageInput').addEventListener('change', handleFileSelect);
            
            // Drag and drop
            dropZone.addEventListener('dragover', handleDragOver);
            dropZone.addEventListener('dragleave', handleDragLeave);
            dropZone.addEventListener('drop', handleDrop);
            dropZone.addEventListener('click', () => {
                document.getElementById('imageInput').click();
            });
            
            // Canvas interaction
            canvas.addEventListener('click', handleCanvasClick);
            
            // Mode toggle
            document.getElementById('toggleModeBtn').addEventListener('click', toggleMode);
            
            // Color dots
            setupColorDots();
            
            // Undo/Redo
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('redoBtn').addEventListener('click', redo);
            
            // Reset
            document.getElementById('resetBtn').addEventListener('click', resetForm);
            
            // Tab switching
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    btn.classList.add('active');
                    document.getElementById(`${btn.dataset.tab}Tab`).classList.add('active');
                });
            });
            
            // Custom fields visibility
            ['image_source', 'expression', 'skin_condition'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', (e) => {
                        const customField = document.getElementById(`custom_${id}_container`);
                        if (customField) {
                            customField.classList.toggle('hidden', e.target.value !== 'Custom');
                        }
                    });
                }
            });
            
            // City and Clothes custom field visibility
            ['city', 'clothes'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('change', () => {
                        const customField = document.getElementById(`custom_${id}_container`);
                        if (customField) {
                            const hasCustom = Array.from(element.selectedOptions).some(opt => opt.value === 'custom');
                            customField.classList.toggle('hidden', !hasCustom);
                        }
                    });
                }
            });
            
            // Input validation
            setupInputValidation();
            
            // Form change events for JSON preview
            document.querySelectorAll('input, select, textarea').forEach(input => {
                input.addEventListener('change', updateJsonPreview);
                input.addEventListener('input', updateJsonPreview);
            });
            
            // Export/Import
            document.getElementById('exportBtn').addEventListener('click', exportJson);
            document.getElementById('jsonInput').addEventListener('change', importJson);
            
            // Click on landmark coordinates textarea to switch to landmark mode
            document.getElementById('landmarkCoordinates').addEventListener('click', () => {
                colorMode = null;
                selectedColorBox = null;
                document.getElementById('toggleModeBtn').textContent = 'üé® Mode: Landmarks';
                updateUI();
            });
        }
        
        // Setup Lighting Tag Input
        function setupLightingTagInput() {
            const tagBox = document.getElementById('lightingTagBox');
            const tagInput = document.getElementById('lightingTagInput');
            
            // Add initial default tag
            addLightingTag('Natural','Indoor');
            
            // Update JSON preview when tags change
            tagBox.addEventListener('DOMSubtreeModified', updateJsonPreview);
        }
        
        function handleLightingKey(e) {
            if (e.key === ',') {
                e.preventDefault();
                let tag = e.target.value.trim().replace(',', '');
                if (tag !== '') {
                    addLightingTag(tag);
                    e.target.value = '';
                }
            }
        }
        
        function addLightingTag(text) {
            const tagBox = document.getElementById('lightingTagBox');
            const tagInput = document.getElementById('lightingTagInput');
            const tag = document.createElement('div');
            tag.className = 'tag';
            tag.innerHTML = `${text} <span onclick="removeLightingTag(this)">√ó</span>`;
            tagBox.insertBefore(tag, tagInput);
            tagBox.classList.remove('empty');
        }
        
        function removeLightingTag(elem) {
            elem.parentElement.remove();
            const tagBox = document.getElementById('lightingTagBox');
            if (tagBox.querySelectorAll('.tag').length === 0) {
                tagBox.classList.add('empty');
            }
        }
        
        function focusLightingInput() {
            document.getElementById('lightingTagInput').focus();
        }
        
        // Reset form to default values, keeping the image
        function resetForm() {
            // Preserve image-related state
            const preservedState = {
                unique_id: document.getElementById('unique_id').value,
                file_name: document.getElementById('file_name').value,
                file_extension: document.getElementById('file_extension').value,
                file_size: document.getElementById('file_size').value,
                dimensions: document.getElementById('dimensions').value,
                comments: document.getElementById('comments').value,
                date: document.getElementById('date').value,
                make: document.getElementById('make').value,
                model: document.getElementById('model').value,
                f_stop: document.getElementById('f_stop').value,
                exposure_time: document.getElementById('exposure_time').value,
                iso_speed: document.getElementById('iso_speed').value,
                exposure_bias: document.getElementById('exposure_bias').value,
                focal_length: document.getElementById('focal_length').value,
                max_aperture: document.getElementById('max_aperture').value,
                metering_mode: document.getElementById('metering_mode').value,
                flash_mode: document.getElementById('flash_mode').value,
                focal_length_35mm: document.getElementById('focal_length_35mm').value,
                age_days: document.getElementById('age_days').value
            };
            
            // Reset global state
            landmarks = {};
            landmarkIndex = 0;
            colorMode = null;
            selectedColorBox = null;
            clothesColours = ['', '', '', ''];
            backgroundColours = ['', '', '', ''];
            skinTones = ['', '', '', ''];
            history = [];
            redoStack = [];
            
            // Reset form fields to defaults
            document.getElementById('name').value = 'Kanhaiyalal';
            document.getElementById('height_cm').value = '178';
            document.getElementById('weight_kg').value = '72';
            
            // Reset city selection
            const citySelect = document.getElementById('city');
            Array.from(citySelect.options).forEach(opt => {
                opt.selected = opt.value === 'Dhadheru_Godaran' || opt.value === 'Jaipur';
            });
            document.getElementById('custom_city').value = '';
            document.getElementById('custom_city_container').classList.add('hidden');
            
            document.getElementById('latitude_longitude').value = '27.964547992823288, 74.34065413108007';
            document.getElementById('image_source').value = 'Smartphone';
            document.getElementById('custom_image_source').value = '';
            document.getElementById('custom_image_source_container').classList.add('hidden');
            document.getElementById('expression').value = 'Neutral';
            document.getElementById('custom_expression').value = '';
            document.getElementById('custom_expression_container').classList.add('hidden');
            document.getElementById('skin_condition').value = 'Normal';
            document.getElementById('custom_skin_condition').value = '';
            document.getElementById('custom_skin_condition_container').classList.add('hidden');
            document.getElementById('wrinkles').value = 'None';
            document.getElementById('hair_color').value = 'Black';
            document.getElementById('beard_length_mm').value = '';
            document.getElementById('moustache').value = 'Yes';
            document.getElementById('moustache_colour').value = 'Black';
            document.getElementById('bath_status').value = 'After Bath';
            
            // Reset clothes selection
            const clothesSelect = document.getElementById('clothes');
            Array.from(clothesSelect.options).forEach(opt => {
                opt.selected = opt.value !== 'custom';
            });
            document.getElementById('custom_clothes').value = '';
            document.getElementById('custom_clothes_container').classList.add('hidden');
            
            // Reset lighting tags
            const lightingTagBox = document.getElementById('lightingTagBox');
            lightingTagBox.querySelectorAll('.tag').forEach(tag => tag.remove());
            addLightingTag('Natural','Indoor');
            
            document.getElementById('uv_index').value = '10';
            document.getElementById('aqi').value = '';
            document.getElementById('humidity_percent').value = '';
            document.getElementById('sleep').value = '8';
            document.getElementById('exercise').value = '0';
            document.getElementById('medications').value = 'Na';
            document.getElementById('skincare').value = 'Na';
            document.getElementById('life_events').value = '';
            document.getElementById('tags').value = '';
            
            // Restore preserved image-related state
            Object.entries(preservedState).forEach(([id, value]) => {
                document.getElementById(id).value = value;
            });
            
            // Update UI
            updateCanvas();
            updateUI();
            updateJsonPreview();
            
            // Save reset state to history
            saveHistory();
        }
        
        // Handle file selection via file input
        function handleFileSelect(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file);
            }
        }
        
        // Handle drag over event
        function handleDragOver(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.add('border-blue-500');
        }
        
        // Handle drag leave event
        function handleDragLeave(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-500');
        }
        
        // Handle drop event
        function handleDrop(e) {
            e.preventDefault();
            e.stopPropagation();
            dropZone.classList.remove('border-blue-500');
            
            const dt = e.dataTransfer;
            const file = dt.files[0];
            
            if (file && (file.type === 'image/jpeg' || file.type === 'image/png')) {
                processFile(file);
            } else {
                alert('Please drop a valid JPEG or PNG image.');
            }
        }
        
        // Process uploaded file
        function processFile(file) {
            // Reset state
            landmarkIndex = 0;
            landmarks = {};
            clothesColours = ['', '', '', ''];
            backgroundColours = ['', '', '', ''];
            skinTones = ['', '', '', ''];
            colorMode = null;
            selectedColorBox = null;
            history = [];
            redoStack = [];
            
            // Populate basic fields
            document.getElementById('unique_id').value = file.name.split('.')[0];
            document.getElementById('file_name').value = file.name;
            document.getElementById('file_extension').value = file.name.split('.').pop().toLowerCase();
            document.getElementById('file_size').value = formatFileSize(file.size);
            
            // Read file
            const reader = new FileReader();
            reader.onload = (e) => {
                // Create image
                image = new Image();
                image.onload = () => {
                    originalImage = image;
                    
                    // Configure canvas
                    canvas.width = Math.min(600, image.width);
                    canvas.height = (image.height / image.width) * canvas.width;
                    
                    // Populate dimensions
                    document.getElementById('dimensions').value = `${image.width}x${image.height}`;
                    
                    // Show canvas, hide drop zone
                    canvas.classList.remove('hidden');
                    dropZone.classList.add('hidden');
                    
                    // Draw image on canvas
                    updateCanvas();
                    
                    // Save initial state to history
                    saveHistory();
                };
                image.src = e.target.result;
                
                // Extract EXIF data
                EXIF.getData(file, function() {
                    try {
                        // Existing EXIF fields
                        const date = EXIF.getTag(this, 'DateTime') || 
                                    EXIF.getTag(this, 'DateTimeOriginal') || 
                                    new Date().toISOString();
                        document.getElementById('date').value = date;
                        
                        // Calculate age in days
                        const birthDate = new Date(2003, 6, 4); // July 4, 2003
                        let captureDate = parseExifDate(date) || new Date();
                        const ageDays = calculateAgeInDays(birthDate, captureDate);
                        document.getElementById('age_days').value = ageDays >= 0 ? ageDays : '';
                        
                        const make = cleanExifValue(EXIF.getTag(this, 'Make')) || '';
                        document.getElementById('make').value = make;
                        
                        const model = cleanExifValue(EXIF.getTag(this, 'Model')) || '';
                        document.getElementById('model').value = model;
                        
                        // New EXIF fields
                        const comments = cleanExifValue(EXIF.getTag(this, 'UserComment') || EXIF.getTag(this, 'ImageDescription')) || '';
                        document.getElementById('comments').value = comments;
                        
                        const fStop = EXIF.getTag(this, 'FNumber');
                        document.getElementById('f_stop').value = fStop ? `f/${fStop}` : '';
                        
                        const exposureTime = EXIF.getTag(this, 'ExposureTime');
                        document.getElementById('exposure_time').value = exposureTime ? `${exposureTime}` : '';
                        
                        const isoSpeed = EXIF.getTag(this, 'ISOSpeedRatings') || EXIF.getTag(this, 'ISO');
                        document.getElementById('iso_speed').value = isoSpeed ? `ISO ${isoSpeed}` : '';
                        
                        const exposureBias = EXIF.getTag(this, 'ExposureBiasValue');
                        document.getElementById('exposure_bias').value = exposureBias ? `${exposureBias} EV` : '';
                        
                        const focalLength = EXIF.getTag(this, 'FocalLength');
                        document.getElementById('focal_length').value = focalLength ? `${focalLength} mm` : '';
                        
                        const maxAperture = EXIF.getTag(this, 'MaxApertureValue');
                        document.getElementById('max_aperture').value = maxAperture ? `f/${maxAperture}` : '';
                        
                        const meteringMode = cleanExifValue(EXIF.getTag(this, 'MeteringMode'));
                        document.getElementById('metering_mode').value = meteringMode || '';
                        
                        const flashMode = cleanExifValue(EXIF.getTag(this, 'Flash'));
                        document.getElementById('flash_mode').value = flashMode || '';
                        
                        const focalLength35mm = EXIF.getTag(this, 'FocalLengthIn35mmFilm');
                        document.getElementById('focal_length_35mm').value = focalLength35mm ? `${focalLength35mm} mm` : '';
                    } catch (err) {
                        console.error('Error extracting EXIF data:', err);
                    }
                });
                
                // Update UI
                updateUI();
                updateJsonPreview();
                
                // Upload to server (if connected)
                uploadToServer(file);
            };
            reader.readAsDataURL(file);
        }
        
        // Format file size
        function formatFileSize(bytes) {
            if (bytes < 1024) return `${bytes} bytes`;
            if (bytes < 1024 * 1024) return `${(bytes / 1024).toFixed(2)} KB`;
            return `${(bytes / (1024 * 1024)).toFixed(2)} MB`;
        }
        
        // Handle canvas click for landmark annotation or color picking
        function handleCanvasClick(e) {
            if (!image.src) return;
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const canvasX = Math.round((e.clientX - rect.left) * scaleX);
            const canvasY = Math.round((e.clientY - rect.top) * scaleY);
            
            if (canvasX >= 0 && canvasX < canvas.width && canvasY >= 0 && canvasY < canvas.height) {
                const imageScaleX = image.width / canvas.width;
                const imageScaleY = image.height / canvas.height;
                let x = Math.round(canvasX * imageScaleX);
                let y = Math.round(canvasY * imageScaleY);
                x = Math.min(Math.max(x, 0), image.width - 1);
                y = Math.min(Math.max(y, 0), image.height - 1);
                
                if (!validateCoordinates(x, y, image.width, image.height)) {
                    alert('Coordinate out of image bounds');
                    return;
                }
                
                if (colorMode && selectedColorBox !== null) {
                    // Pick color
                    const pixel = ctx.getImageData(canvasX, canvasY, 1, 1).data;
                    const hex = `#${((1 << 24) + (pixel[0] << 16) + (pixel[1] << 8) + pixel[2]).toString(16).slice(1).padStart(6, '0')}`;
                    
                    if (colorMode === 'clothes_colour') {
                        clothesColours[selectedColorBox] = hex;
                        document.getElementById(`clothes_colour_${selectedColorBox}`).style.backgroundColor = hex;
                    } else if (colorMode === 'background_colour') {
                        backgroundColours[selectedColorBox] = hex;
                        document.getElementById(`background_colour_${selectedColorBox}`).style.backgroundColor = hex;
                    } else if (colorMode === 'skin_tone') {
                        skinTones[selectedColorBox] = hex;
                        document.getElementById(`skin_tone_${selectedColorBox}`).style.backgroundColor = hex;
                    }
                    
                    // Move to next color slot or reset
                    selectedColorBox = selectedColorBox < 3 ? selectedColorBox + 1 : null;
                } else if (!colorMode && landmarkIndex < landmarkKeys.length) {
                    // Collect landmark
                    const key = landmarkKeys[landmarkIndex];
                    setLandmark(key, { x, y });
                    landmarkIndex++;
                }
                
                saveHistory();
                updateCanvas();
                updateUI();
                updateJsonPreview();
            }
        }
        
        // Validate coordinates
        function validateCoordinates(x, y, width, height) {
            return x >= 0 && x < width && y >= 0 && y < height;
        }
        
        // Set landmark coordinates
        function setLandmark(key, point) {
            landmarks[key] = { x: point.x, y: point.y };
            console.log(`Captured ${key}: (${point.x}, ${point.y})`);
        }
        
        // Toggle between landmark and color modes
        function toggleMode() {
            const modes = [null, 'clothes_colour', 'background_colour', 'skin_tone'];
            const currentIndex = modes.indexOf(colorMode);
            colorMode = modes[(currentIndex + 1) % modes.length];
            
            // Update mode button text
            const modeLabels = {
                null: 'Landmarks',
                'clothes_colour': 'Clothes Colors',
                'background_colour': 'Background Colors',
                'skin_tone': 'Skin Tones'
            };
            
            document.getElementById('toggleModeBtn').textContent = `üé® Mode: ${modeLabels[colorMode]}`;
            
            // Reset color index for color modes
            selectedColorBox = colorMode ? 0 : null;
            
            updateUI();
        }
        
        // Setup color dot event listeners
        function setupColorDots() {
            for (let i = 0; i < 4; i++) {
                document.getElementById(`clothes_colour_${i}`).addEventListener('click', () => {
                    colorMode = 'clothes_colour';
                    selectedColorBox = i;
                    document.getElementById('toggleModeBtn').textContent = 'üé® Mode: Clothes Colors';
                    updateUI();
                });
                document.getElementById(`background_colour_${i}`).addEventListener('click', () => {
                    colorMode = 'background_colour';
                    selectedColorBox = i;
                    document.getElementById('toggleModeBtn').textContent = 'üé® Mode: Background Colors';
                    updateUI();
                });
                document.getElementById(`skin_tone_${i}`).addEventListener('click', () => {
                    colorMode = 'skin_tone';
                    selectedColorBox = i;
                    document.getElementById('toggleModeBtn').textContent = 'üé® Mode: Skin Tones';
                    updateUI();
                });
            }
        }
        
        // Update canvas with image and landmarks
        function updateCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (image.src) {
                ctx.drawImage(image, 0, 0, canvas.width, canvas.height);
            }
            
            // Draw landmarks
            for (let key of landmarkKeys.slice(0, landmarkIndex)) {
                const point = landmarks[key];
                if (point && point.x != null && point.y != null) {
                    const canvasX = point.x * (canvas.width / image.width);
                    const canvasY = point.y * (canvas.height / image.height);
                    ctx.beginPath();
                    ctx.arc(canvasX, canvasY, 3, 0, 2 * Math.PI);
                    ctx.fillStyle = 'red';
                    ctx.fill();
                }
            }
        }
        
        // Update UI elements
        function updateUI() {
            // Update landmark count
            const collectedCount = Object.keys(landmarks).length;
            document.getElementById('collectedCount').textContent = collectedCount;
            
            // Update current landmark display
            if (!colorMode && landmarkIndex < landmarkKeys.length) {
                currentLandmark.textContent = `Next: ${landmarkKeys[landmarkIndex]}`;
                currentLandmark.classList.remove('hidden');
            } else {
                currentLandmark.classList.add('hidden');
            }
            
            // Update color dots
            updateColorBoxes();
            
            // Update landmark coordinates textarea
            updateLandmarkCoordinates();
            
            // Update undo/redo buttons
            updateUndoRedoButtons();
            
            // Update cursor style
            updateCursorStyle();
        }
        
        // Update color boxes
        function updateColorBoxes() {
            for (let i = 0; i < 4; i++) {
                const clothesBox = document.getElementById(`clothes_colour_${i}`);
                const backgroundBox = document.getElementById(`background_colour_${i}`);
                const skinToneBox = document.getElementById(`skin_tone_${i}`);
                clothesBox.style.backgroundColor = clothesColours[i] || '#4b5563';
                backgroundBox.style.backgroundColor = backgroundColours[i] || '#4b5563';
                skinToneBox.style.backgroundColor = skinTones[i] || '#4b5563';
                clothesBox.style.transition = 'all 0.3s ease';
                backgroundBox.style.transition = 'all 0.3s ease';
                skinToneBox.style.transition = 'all 0.3s ease';
            }
        }
        
        // Update cursor style
        function updateCursorStyle() {
            if (colorMode && selectedColorBox !== null) {
                canvas.style.cursor = 'crosshair';
            } else if (!colorMode && landmarkIndex < landmarkKeys.length) {
                canvas.style.cursor = 'url("data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAUAAAAFCAYAAACNbyblAAAAHElEQVQI12P4//8/w38GIAXDIBKE0DHxgljNBAAO9TXL0Y4OHgwAAAABJRU5ErkJggg==") 4 4, auto';
            } else {
                canvas.style.cursor = 'default';
            }
        }
        
        // Update landmark coordinates textarea
        function updateLandmarkCoordinates() {
            const textarea = document.getElementById('landmarkCoordinates');
            let text = '';
            for (let key of landmarkKeys.slice(0, landmarkIndex)) {
                const point = landmarks[key];
                if (point && point.x != null && point.y != null) {
                    text += `${key}: (${point.x}, ${point.y})\n`;
                }
            }
            textarea.value = text;
        }
        
        // Save current state to history
        function saveHistory() {
            if (isImporting) return;
            history.push(JSON.parse(JSON.stringify({
                landmarks,
                landmarkIndex,
                clothesColours,
                backgroundColours,
                skinTones
            })));
            if (history.length > 50) history.shift();
            redoStack = [];
            updateUndoRedoButtons();
        }
        
        // Undo last action
        function undo() {
            if (history.length <= 1) return;
            redoStack.push(history.pop());
            const state = history[history.length - 1];
            landmarks = JSON.parse(JSON.stringify(state.landmarks));
            landmarkIndex = state.landmarkIndex;
            clothesColours = state.clothesColours;
            backgroundColours = state.backgroundColours;
            skinTones = state.skinTones;
            updateCanvas();
            updateUI();
            updateJsonPreview();
        }
        
        // Redo last undone action
        function redo() {
            if (redoStack.length === 0) return;
            const state = redoStack.pop();
            history.push(state);
            landmarks = JSON.parse(JSON.stringify(state.landmarks));
            landmarkIndex = state.landmarkIndex;
            clothesColours = state.clothesColours;
            backgroundColours = state.backgroundColours;
            skinTones = state.skinTones;
            updateCanvas();
            updateUI();
            updateJsonPreview();
        }
        
        // Update undo/redo buttons
        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = history.length <= 1;
            document.getElementById('redoBtn').disabled = redoStack.length === 0;
        }
        
        // Setup input validation
        function setupInputValidation() {
            // Validation for numeric inputs
            ['height_cm', 'weight_kg', 'aqi', 'exercise'].forEach(id => {
                const input = document.getElementById(id);
                if (input) {
                    input.addEventListener('input', () => {
                        if (input.value < input.min) input.value = input.min;
                        if (input.max && input.value > input.max) input.value = input.max;
                    });
                }
            });
            
            // UV Index validation (integer, 1-11)
            const uvIndexInput = document.getElementById('uv_index');
            if (uvIndexInput) {
                uvIndexInput.addEventListener('input', () => {
                    let value = parseInt(uvIndexInput.value);
                    if (isNaN(value) || value < 1) {
                        uvIndexInput.value = 1;
                    } else if (value > 11) {
                        uvIndexInput.value = 11;
                    } else {
                        uvIndexInput.value = value;
                    }
                });
            }
            
            // Sleep validation (float, 0-24, step 0.5)
            const sleepInput = document.getElementById('sleep');
            if (sleepInput) {
                sleepInput.addEventListener('input', () => {
                    let value = parseFloat(sleepInput.value);
                    if (isNaN(value) || value < 0) {
                        sleepInput.value = 0;
                    } else if (value > 24) {
                        sleepInput.value = 24;
                    } else {
                        // Round to nearest 0.5
                        value = Math.round(value * 2) / 2;
                        sleepInput.value = value;
                    }
                });
            }
        }
        
        // Update JSON preview
        function updateJsonPreview() {
            const data = collectFormData();
            document.getElementById('jsonPreview').textContent = JSON.stringify(data, null, 2);
        }
        
        // Collect form data for JSON
        function collectFormData() {
            // Collect city selections
            const citySelect = document.getElementById('city');
            const cityOptions = Array.from(citySelect.selectedOptions).map(opt => opt.value);
            const cityArray = cityOptions.filter(opt => opt !== 'custom');
            const customCityInput = document.getElementById('custom_city');
            if (cityOptions.includes('custom') && customCityInput.value) {
                cityArray.push(...customCityInput.value.split(',').map(s => s.trim()).filter(s => s));
            }
            
            // Collect clothes selections
            const clothesSelect = document.getElementById('clothes');
            const clothesOptions = Array.from(clothesSelect.selectedOptions).map(opt => opt.value);
            const clothesArray = clothesOptions.filter(opt => opt !== 'custom');
            const customClothesInput = document.getElementById('custom_clothes');
            if (clothesOptions.includes('custom') && customClothesInput.value) {
                clothesArray.push(...customClothesInput.value.split(',').map(s => s.trim()).filter(s => s));
            }
            
            // Collect lighting tags
            const lightingTagBox = document.getElementById('lightingTagBox');
            const lightingTags = Array.from(lightingTagBox.querySelectorAll('.tag')).map(tag => {
                return tag.textContent.replace('√ó', '').trim();
            });
            
            // Validate UV Index
            let uvIndex = parseInt(document.getElementById('uv_index').value);
            if (isNaN(uvIndex) || uvIndex < 1) uvIndex = 1;
            if (uvIndex > 11) uvIndex = 11;
            
            // Validate Sleep
            let sleep = parseFloat(document.getElementById('sleep').value);
            if (isNaN(sleep) || sleep < 0) sleep = 0;
            if (sleep > 24) sleep = 24;
            sleep = Math.round(sleep * 2) / 2; // Round to nearest 0.5
            
            return {
                unique_id: document.getElementById('unique_id').value,
                file_name: document.getElementById('file_name').value,
                file_extension: document.getElementById('file_extension').value,
                file_size: document.getElementById('file_size').value,
                dimensions: document.getElementById('dimensions').value,
                comments: document.getElementById('comments').value,
                date: document.getElementById('date').value,
                camera_maker: document.getElementById('make').value,
                model: document.getElementById('model').value,
                f_stop: document.getElementById('f_stop').value,
                exposure_time: document.getElementById('exposure_time').value,
                iso_speed: document.getElementById('iso_speed').value,
                exposure_bias: document.getElementById('exposure_bias').value,
                focal_length: document.getElementById('focal_length').value,
                max_aperture: document.getElementById('max_aperture').value,
                metering_mode: document.getElementById('metering_mode').value,
                flash_mode: document.getElementById('flash_mode').value,
                focal_length_35mm: document.getElementById('focal_length_35mm').value,
                name: document.getElementById('name').value,
                age_days: parseInt(document.getElementById('age_days').value) || 0,
                height_cm: parseFloat(document.getElementById('height_cm').value) || 0,
                weight_kg: parseFloat(document.getElementById('weight_kg').value) || 0,
                city: cityArray,
                latitude_longitude: document.getElementById('latitude_longitude').value,
                image_source: document.getElementById('image_source').value === 'Custom' ? 
                    document.getElementById('custom_image_source').value : 
                    document.getElementById('image_source').value,
                expression: document.getElementById('expression').value === 'Custom' ? 
                    document.getElementById('custom_expression').value : 
                    document.getElementById('expression').value,
                skin_condition: document.getElementById('skin_condition').value === 'Custom' ? 
                    document.getElementById('custom_skin_condition').value : 
                    document.getElementById('skin_condition').value,
                wrinkles: document.getElementById('wrinkles').value,
                hair_color: document.getElementById('hair_color').value,
                beard_length_mm: document.getElementById('beard_length_mm').value,
                moustache: document.getElementById('moustache').value,
                moustache_colour: document.getElementById('moustache_colour').value,
                bath_status: document.getElementById('bath_status').value,
                clothes: clothesArray,
                clothes_colour: clothesColours.filter(c => c),
                background_colour: backgroundColours.filter(c => c),
                skin_tone: skinTones.filter(c => c),
                lighting: lightingTags,
                uv_index: uvIndex,
                aqi: parseInt(document.getElementById('aqi').value) || 0,
                humidity_percent: parseInt(document.getElementById('humidity_percent').value) || 0,
                sleep: sleep,
                exercise: parseFloat(document.getElementById('exercise').value) || 0,
                medications: document.getElementById('medications').value.split(',').map(s => s.trim()).filter(s => s),
                skincare: document.getElementById('skincare').value.split('\n').map(s => s.trim()).filter(s => s),
                life_events: document.getElementById('life_events').value.split('\n').map(s => s.trim()).filter(s => s),
                tags: document.getElementById('tags').value.split(',').map(s => s.trim()).filter(s => s),
                landmarks: landmarks
            };
        }
        
        // Export JSON
        function exportJson() {
            const data = collectFormData();
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            const fileName = data.file_name ? data.file_name.split('.').slice(0, -1).join('.') : (data.unique_id || 'data');
            a.download = `${fileName}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }
        
        // Import JSON
        function importJson(e) {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        isImporting = true;
                        const data = JSON.parse(event.target.result);
                        
                        // Populate form fields
                        document.getElementById('unique_id').value = data.unique_id || '';
                        document.getElementById('file_name').value = data.file_name || '';
                        document.getElementById('file_extension').value = data.file_extension || '';
                        document.getElementById('file_size').value = data.file_size || '';
                        document.getElementById('dimensions').value = data.dimensions || '';
                        document.getElementById('comments').value = data.comments || '';
                        document.getElementById('date').value = data.date || '';
                        document.getElementById('make').value = data.camera_maker || data.make || '';
                        document.getElementById('model').value = data.model || '';
                        document.getElementById('f_stop').value = data.f_stop || '';
                        document.getElementById('exposure_time').value = data.exposure_time || '';
                        document.getElementById('iso_speed').value = data.iso_speed || '';
                        document.getElementById('exposure_bias').value = data.exposure_bias || '';
                        document.getElementById('focal_length').value = data.focal_length || '';
                        document.getElementById('max_aperture').value = data.max_aperture || '';
                        document.getElementById('metering_mode').value = data.metering_mode || '';
                        document.getElementById('flash_mode').value = data.flash_mode || '';
                        document.getElementById('focal_length_35mm').value = data.focal_length_35mm || '';
                        document.getElementById('name').value = data.name || 'Kanhaiyalal';
                        document.getElementById('age_days').value = data.age_days || '';
                        document.getElementById('height_cm').value = data.height_cm || '178';
                        document.getElementById('weight_kg').value = data.weight_kg || '72';
                        
                        // Populate city
                        const citySelect = document.getElementById('city');
                        const cityOptions = ['Dhadheru_Godaran', 'Jaipur', 'custom'];
                        const customCities = data.city ? data.city.filter(c => !cityOptions.includes(c)) : [];
                        Array.from(citySelect.options).forEach(opt => {
                            opt.selected = data.city ? (data.city.includes(opt.value) || opt.value === 'custom' && customCities.length > 0) : opt.value !== 'custom';
                        });
                        const customCityInput = document.getElementById('custom_city');
                        customCityInput.value = customCities.join(', ');
                        document.getElementById('custom_city_container').classList.toggle('hidden', !customCities.length || !data.city || !data.city.includes('custom'));
                        
                        document.getElementById('latitude_longitude').value = data.latitude_longitude || '27.964547992823288, 74.34065413108007';
                        document.getElementById('image_source').value = data.image_source || 'Smartphone';
                        document.getElementById('custom_image_source').value = data.image_source || '';
                        document.getElementById('expression').value = data.expression || 'Neutral';
                        document.getElementById('custom_expression').value = data.expression || '';
                        document.getElementById('skin_condition').value = data.skin_condition || 'Normal';
                        document.getElementById('custom_skin_condition').value = data.skin_condition || '';
                        document.getElementById('wrinkles').value = data.wrinkles || 'None';
                        document.getElementById('hair_color').value = data.hair_color || 'Black';
                        document.getElementById('beard_length_mm').value = data.beard_length_mm || '';
                        document.getElementById('moustache').value = data.moustache || 'Yes';
                        document.getElementById('moustache_colour').value = data.moustache_colour || 'Black';
                        document.getElementById('bath_status').value = data.bath_status || 'After Bath';
                        
                        // Populate clothes
                        const clothesSelect = document.getElementById('clothes');
                        const clothesOptions = ['shirt', 't-shirt', 'coat', 'custom'];
                        const customClothes = data.clothes ? data.clothes.filter(c => !clothesOptions.includes(c)) : [];
                        Array.from(clothesSelect.options).forEach(opt => {
                            opt.selected = data.clothes ? (data.clothes.includes(opt.value) || opt.value === 'custom' && customClothes.length > 0) : true;
                        });
                        const customClothesInput = document.getElementById('custom_clothes');
                        customClothesInput.value = customClothes.join(', ');
                        document.getElementById('custom_clothes_container').classList.toggle('hidden', !customClothes.length || !data.clothes || !data.clothes.includes('custom'));
                        
                        // Populate lighting tags
                        const lightingTagBox = document.getElementById('lightingTagBox');
                        lightingTagBox.querySelectorAll('.tag').forEach(tag => tag.remove());
                        const lightingValues = data.lighting && Array.isArray(data.lighting) ? data.lighting : ['Natural','Indoor'];
                        lightingValues.forEach(tag => addLightingTag(tag));
                        if (lightingValues.length > 0) {
                            lightingTagBox.classList.remove('empty');
                        }
                        
                        document.getElementById('uv_index').value = data.uv_index || '10';
                        document.getElementById('aqi').value = data.aqi || '';
                        document.getElementById('humidity_percent').value = data.humidity_percent || '';
                        document.getElementById('sleep').value = data.sleep || '8';
                        document.getElementById('exercise').value = data.exercise || '0';
                        document.getElementById('medications').value = data.medications ? data.medications.join(', ') : 'Na';
                        document.getElementById('skincare').value = data.skincare ? data.skincare.join('\n') : 'Na';
                        document.getElementById('life_events').value = data.life_events ? data.life_events.join('\n') : '';
                        document.getElementById('tags').value = data.tags ? data.tags.join(', ') : '';
                        
                        // Update colors
                        clothesColours = data.clothes_colour ? [...data.clothes_colour, ...Array(4 - data.clothes_colour.length).fill('')] : ['', '', '', ''];
                        backgroundColours = data.background_colour ? [...data.background_colour, ...Array(4 - data.background_colour.length).fill('')] : ['', '', '', ''];
                        skinTones = data.skin_tone ? [...data.skin_tone, ...Array(4 - data.skin_tone.length).fill('')] : ['', '', '', ''];
                        
                        // Update landmarks
                        landmarks = {};
                        if (data.landmarks) {
                            for (const key of landmarkKeys) {
                                if (data.landmarks[key]) {
                                    const point = data.landmarks[key];
                                    landmarks[key] = {
                                        x: point.x || point[0] || 0,
                                        y: point.y || point[1] || 0
                                    };
                                }
                            }
                        }
                        landmarkIndex = Object.keys(landmarks).length;
                        
                        // Update UI
                        updateCanvas();
                        updateUI();
                        updateJsonPreview();
                    } catch (err) {
                        console.error('Error importing JSON:', err);
                        alert('Invalid JSON file.');
                    } finally {
                        isImporting = false;
                    }
                };
                reader.readAsText(file);
            }
        }
        
        // Upload file to server
        function uploadToServer(file) {
            // Placeholder for server upload
            console.log('Uploading to server:', file.name);
            // Implement actual server upload logic here
        }
        
        // Initialize on load
        window.onload = init;
    </script>
